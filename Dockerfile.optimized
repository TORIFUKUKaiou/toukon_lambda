# ğŸ”¥ æœ€é©åŒ–ç‰ˆDockerfile - ã‚µã‚¤ã‚ºå‰Šæ¸›ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
# ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ + Alpineæœ€é©åŒ– + ä¸è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å‰Šé™¤

# === ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆé–‹ç™ºç”¨ãƒ„ãƒ¼ãƒ«å«ã‚€ï¼‰ ===
FROM hexpm/elixir:1.18.4-erlang-28.0.2-alpine-3.22.1 AS builder

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR /app

# ãƒ“ãƒ«ãƒ‰ä¾å­˜é–¢ä¿‚ã‚’ä¸€åº¦ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼æœ€é©åŒ–ï¼‰
RUN apk add --no-cache --virtual .build-deps \
    build-base \
    git \
    curl && \
    apk add --no-cache \
    libstdc++ \
    libgcc

# Mixè¨­å®šï¼ˆéå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ + æœ€é©åŒ–ï¼‰
ENV DEBIAN_FRONTEND=noninteractive \
    TERM=xterm \
    MIX_ENV=prod \
    ERL_FLAGS="+JPperf true" \
    ELIXIR_ERL_OPTIONS="+JPperf true"

RUN mix local.hex --force && \
    mix local.rebar --force

# ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡åŒ–ï¼‰
COPY mix.exs mix.lock ./

# æœ¬ç•ªç”¨ä¾å­˜é–¢ä¿‚ã‚’å–å¾—ãƒ»ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼ˆä¸€æ‹¬å‡¦ç†ï¼‰
RUN mix deps.get --only prod && \
    mix deps.compile

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY config ./config
COPY lib ./lib

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ« + ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ï¼ˆæœ€é©åŒ–ãƒ•ãƒ©ã‚°ï¼‰
RUN mix compile && \
    mix release --overwrite

# ä¸è¦ãªãƒ“ãƒ«ãƒ‰ä¾å­˜é–¢ä¿‚ã‚’å‰Šé™¤ï¼ˆã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰
RUN apk del .build-deps

# === è¶…è»½é‡ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM alpine:3.22.1 AS runtime

# æœ€å°é™ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¾å­˜é–¢ä¿‚ã®ã¿ï¼ˆã‚µã‚¤ã‚ºæœ€é‡è¦–ï¼‰
RUN apk add --no-cache \
    openssl \
    ncurses-libs \
    libstdc++ \
    libgcc \
    ca-certificates

# AWS Lambda RIEï¼ˆè»½é‡ç‰ˆï¼‰ã‚’æ¡ä»¶ä»˜ãã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ARG INSTALL_RIE=true
RUN if [ "$INSTALL_RIE" = "true" ]; then \
        wget -O /usr/local/bin/aws-lambda-rie \
        https://github.com/aws/aws-lambda-runtime-interface-emulator/releases/latest/download/aws-lambda-rie && \
        chmod +x /usr/local/bin/aws-lambda-rie; \
    fi

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR /var/task

# ãƒ“ãƒ«ãƒ‰ã—ãŸãƒªãƒªãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆæœ€å°é™ï¼‰
COPY --from=builder /app/_build/prod/rel/toukon_lambda ./

# Lambdaç”¨ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
COPY bootstrap /var/task/bootstrap
RUN chmod +x /var/task/bootstrap

# ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆæœ€é©åŒ–ï¼‰
ENV PATH="/var/task/bin:$PATH" \
    ERL_FLAGS="+JPperf true" \
    ELIXIR_ERL_OPTIONS="+JPperf true"

# ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆè¿½åŠ ã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰
RUN find /var/task -name "*.beam.cache" -delete && \
    find /var/task -name "*.app.src" -delete && \
    rm -rf /var/task/releases/*/lib/*/src 2>/dev/null || true

# ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆè¨­å®š
ENTRYPOINT ["/var/task/bootstrap"]
